<!DOCTYPE html>
<html lang="en">

<head>

   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
   <title>Litematic Viewer</title>

   <!-- Deepslate -->
   <script src="https://unpkg.com/deepslate@0.10.1"></script>
   <script src="https://unpkg.com/gl-matrix@3.4.3/gl-matrix-min.js"></script>

   <script src="resource/assets.js"></script>
   <script src="resource/opaque.js"></script>

   <!-- Materialize -->
   <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
      media="screen,projection" />

   <!-- Icons -->
   <script src="https://kit.fontawesome.com/92330e144e.js" crossorigin="anonymous"></script>

   <style>
      @media (prefers-color-scheme: light) {
         body {
            background: #FFF;
            color: #111;
         }
      }

      @media (prefers-color-scheme: dark) {
         body {
            background: #111;
            color: #FFF;
         }

         input#remote-url {
            color: white;
         }
      }
   </style>

   <script src="src/deepslate-helpers.js"></script>
   <script src="src/litematic-utils.js"></script>
   <script src="src/main.js"></script>
   <script src="src/settings.js"></script>
   <script src="src/viewer.js"></script>

   <!-- Google tag (gtag.js) -->
   <script async src="https://www.googletagmanager.com/gtag/js?id=G-C0DVDW0WXS"></script>
   <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());

      gtag('config', 'G-C0DVDW0WXS');
   </script>

   <style>
      #viewer {
         position: fixed;
         left: 0;
         top: 0;
         width: 100%;
         height: 100%;
         z-index: -1;
      }

      .settings-section {
         margin-bottom: 20px;
         display: grid;
         width: fit-content;
         margin: auto;
         grid-template-columns: repeat(4, auto);
         grid-template-rows: repeat(6, 1fr);
         grid-column-gap: 0px;
         grid-row-gap: 0px;
      }

      #settings-button {
         position: absolute;
         top: 0;
         right: 25px;
         font-size: 36px;
         margin-left: 50px;
         z-index: 1;
      }

      #settings-panel {
         height: 100%;
         /* 100% Full-height */
         width: 0;
         /* 0 width - change this with JavaScript */
         position: fixed;
         /* Stay in place */
         z-index: 1;
         /* Stay on top */
         top: 0;
         /* Stay at the top */
         right: 0;
         opacity: 90%;
         background-color: #111;
         /* Black*/
         overflow-x: hidden;
         /* Disable horizontal scroll */
         padding-top: 60px;
         /* Place content 60px from the top */
         transition: 0.5s;
         /* 0.5 second transition effect to slide in the sidenav */
      }

      /* Position and style the close button (top right corner) */
      #settings-panel .closebtn {
         position: absolute;
         top: 0;
         right: 25px;
         font-size: 36px;
         margin-left: 50px;
      }

      #materialList {
         position: absolute;
         top: 10px;
         left: 50px;
         column-width: 200px;
         max-height: 80vh;
      }

      #materialList .count-item {
         display: grid;
         background-color: #000;
         grid-template-columns: 1fr auto;
         gap: 0px;
         padding: 5px;
      }

      #materialListButton {
         position: absolute;
         padding: 8px;
      }

      #sliders input[type="range"] {
         writing-mode: vertical-lr;
         direction: rtl;
         appearance: slider-vertical;
         position: absolute;
         background-color: #000;
         width: 20px;
         top: 35px;
         height: 90%;
         vertical-align: bottom;
      }

      #sliders #maxy {
         left: 25px;
      }
   </style>

</head>

<body>

   <nav class="black" style="height: 64px; line-height: 64px;">
      <div class="nav-wrapper">
         <a href="#" class="brand-logo left"
            style="display: flex; align-items: center; height: 100%; padding-left: 10px;">
            <img src="resource/ALL.gif" alt="AllTheBuilds" style="height: 50px;">
         </a>
         <ul id="nav-mobile" class="right">
            <li><a href="https://discord.gg/C2dHwBb3k3" target="_blank" style="font-size: 1.2rem;"><i
                     class="fab fa-discord"></i> Join our Discord</a></li>
         </ul>
      </div>
   </nav>

   <div id="viewer" width="100%"></div>


   <button id="materialListButton" hidden><span class="material-icons">list</span></button>
   <div id="materialList" hidden></div>

   <div id="loading-spinner" class="center" hidden
      style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;">
      <img id="loading-gif" src="resource/ALL.gif" alt="Loading..." style="max-width: 200px; height: auto;">
   </div>

   <div id="main-content">

      <div class="section no-pad-bot">
         <div class="container">
         </div>
      </div>

      <div class="container">
         <div class="row">
            <div class="col s12" id="file-loader-panel">
               <input id="file-upload" type="file" onchange="readFileInput(this)" hidden multiple />

               <label for="file-upload" id="drop-zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);"
                  width="100%">
                  <div class="card-panel center gray lighten-1">
                     <h3>Select file(s)</h3>

                     <span id="file-upload-btn" class="btn btn-floating btn-large waves-effect waves-light red"><i
                           class="material-icons">add</i></span>

                  </div>
               </label>

               <h3>or paste a .litematic link:</h3>
               <form>
                  <div class="input-field">
                     <input id="remote-url" type="text" name="remote-url" class="validate">
                     <label for="remote-url">URL</label>
                     <button class="btn waves-effect waves-light" type="submit"
                        onclick="submitFileLink(document.getElementById('remote-url').value)">Confirm<i
                           class="material-icons right">send</i></button>
                  </div>
               </form>
            </div>
         </div>
      </div>


      <!-- Texture atlas -->
      <img id="atlas" src="resource/atlas.png" alt="Texture atlas" crossorigin="anonymous" hidden>

      <script>

         // Add listener to load resrouces from atlas
         // TODO - move to index as an onload?
         document.addEventListener("DOMContentLoaded", function (event) {

            console.log("Adding loader")

            const image = document.getElementById('atlas');
            if (image.complete) {
               console.log("Adding loader")
               loadDeepslateResources(image);
            } else {
               console.log("Setting up load listener");
               image.addEventListener('load', () => {
                  console.log("Image load event triggered");
                  loadDeepslateResources(image);
               });
            }

            image.addEventListener('error', (error) => {
               console.error("Error loading image:", error);
            });

         });

         document.addEventListener("DOMContentLoaded", function (event) {
            const urlParams = new URLSearchParams(window.location.search);
            let remoteUrl = urlParams.get('remote-url');

            if (window.location.hash) {
               remoteUrl = window.location.hash.substring(1);
            }

            if (remoteUrl) {
               console.log("Loading file from", remoteUrl);

               // Hide upload panel immediately
               const loaderPanel = document.getElementById('file-loader-panel');
               if (loaderPanel) loaderPanel.style.display = 'none';

               // Show spinner
               const spinner = document.getElementById('loading-spinner');
               if (spinner) {
                  spinner.hidden = false;
                  animateLoader();
               }

               readFileURL(remoteUrl);
            }
         });

         function animateLoader() {
            const img = document.getElementById('loading-gif');
            const spinner = document.getElementById('loading-spinner');

            // Stop if spinner is hidden or elements missing
            if (!img || !spinner || spinner.hidden) return;

            // Restart gif by updating src with timestamp
            img.src = "resource/ALL.gif?t=" + new Date().getTime();

            const gifDuration = 3000; // 3 seconds
            const pauseDuration = 1000; // 1 second

            setTimeout(animateLoader, gifDuration + pauseDuration);
         }

         function readFileInput(input) {
            for (let i = 0; i < input.files.length; i++) {
               let file = input.files[i];
               loadAndProcessFile(file);
            }
         }

         function readFileURL(url, useProxy = true) {
            // TODO: This URL probably shouldn't be hardcoded
            var proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
            var request = new XMLHttpRequest();
            request.responseType = 'blob';
            request.onreadystatechange = function () {
               if (request.readyState == XMLHttpRequest.DONE) {
                  if (request.status === 200) {
                     console.log("Loaded file from remote url");
                     console.log(request.response);
                     loadAndProcessFile(request.response);
                  }
                  else {
                     console.log("Error loading litematic");
                     console.log(request);
                  }
               }
            };
            request.open('GET', proxyUrl, true);
            request.send();
         }

         function dragOverHandler(ev) {
            // Prevent default behavior (Prevent file from being opened)
            ev.preventDefault();
         }

         function dropHandler(ev) {
            console.log('File(s) dropped');

            // Prevent default behavior (Prevent file from being opened)
            ev.preventDefault();

            if (ev.dataTransfer.items) {
               // Use DataTransferItemList interface to access the file(s)
               for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                  // If dropped items aren't files, reject them
                  if (ev.dataTransfer.items[i].kind === 'file') {
                     const file = ev.dataTransfer.items[i].getAsFile();
                     console.log('... file[' + i + '].name = ' + file.name);
                     loadAndProcessFile(file);
                  }
               }
            } else {
               // Use DataTransfer interface to access the file(s)
               console.log('DataTransfer interface not implemented!')
               for (let i = 0; i < ev.dataTransfer.files.length; i++) {
                  console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
               }

            }
         }

      </script>

   </div>



   <!--JavaScript at end of body for optimized loading-->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>